stages:
  - build
  - deploy
  - release

services:
  - nexus.ocr.cr14.net:8003/mariadb:10.7

variables:
  MYSQL_ROOT_PASSWORD: mysql_root
  MYSQL_USER: mysql_user
  MYSQL_PASSWORD: mysql_pass
  MYSQL_DATABASE: deputy

build-frontend:
  stage: build
  image: $DOCKER_REGISTRY_PULL/frontend-builder
  script:
    - yarn --cwd ./web-client/
    - yarn --cwd ./web-client/ lint
  only:
    - develop
    - master
    - merge_requests
    - tags

lint-and-test:
  stage: build
  image: $DOCKER_REGISTRY_PULL/rust-builder
  script:
    - cargo clippy -- -Dwarnings
    - cargo test
    # - cargo tarpaulin --skip-clean --out Xml
  # coverage: '/^\d+.\d+% coverage/'
  # artifacts:
  #   reports:
  #     coverage_report:
  #       coverage_format: cobertura
  #       path: coverage/cobertura-coverage.xml
  only:
    - develop
    - master
    - merge_requests
    - tags

build-and-upload-x86-64bit-linux-release-for-deputy-package-server:
  stage: build
  needs: ["lint-and-test"]
  image: $DOCKER_REGISTRY_PULL/rust-builder
  script:
    - cargo deb --target x86_64-unknown-linux-gnu -p deputy-package-server
    - DEB_FILE=$(find ./target/x86_64-unknown-linux-gnu/debian/ -maxdepth 1 -type f -name "*.deb")
    - 'curl -u $OCR_DEPLOYMENT_USER:$OCR_DEPLOYMENT_PASSWORD -X POST -H "Content-Type: multipart/form-data" --data-binary "@$DEB_FILE" $OCR_APT_REPOSITORY'
  only:
    - /^deputy-package-server-.*$/
  except:
    - branches

build-and-upload-x86-64bit-linux-release-for-deputy-cli:
  stage: build
  needs: ["lint-and-test"]
  image: $DOCKER_REGISTRY_PULL/rust-builder
  script:
    - cargo deb --target x86_64-unknown-linux-gnu -p deputy
    - DEB_FILE=$(find ./target/x86_64-unknown-linux-gnu/debian/ -maxdepth 1 -type f -name "*.deb")
    - 'curl -u $OCR_DEPLOYMENT_USER:$OCR_DEPLOYMENT_PASSWORD -X POST -H "Content-Type: multipart/form-data" --data-binary "@$DEB_FILE" $OCR_APT_REPOSITORY'
  only:
    - /^deputy-cli-.*$/
  except:
    - branches

staging:
  variables:
    DEPUTY_PACKAGE_SERVER: "1"
    DEPUTY: "1"
  stage: deploy
  needs:
    - job: build-and-upload-x86-64bit-linux-release-for-deputy-cli
      optional: true
    - job: build-and-upload-x86-64bit-linux-release-for-deputy-package-server
      optional: true
  trigger:
    project: open-cyber-range/internal/support-docker-images
    strategy: depend
  only:
    - master
    - tags

release-to-internal-network:
  stage: release
  needs: ["staging"]
  script:
    - apt-get update -y && apt-get install openssh-client -y
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$OCR_SERVICE_PRIVATE_KEY")
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'

    - ssh -t service@deputy.ocr.cr14.net "docker kill $(docker ps -q) || echo 'No containers to kill'"
    - ssh -t service@deputy.ocr.cr14.net "rm -rf deployment"
    - ssh -t service@deputy.ocr.cr14.net "mkdir -p deployment"
    - scp -r ./deputy-package-server/deployment/* service@deputy.ocr.cr14.net:~/deployment
    - ssh -t service@deputy.ocr.cr14.net "cd deployment && docker compose pull && docker compose up -d --pull always --force-recreate --remove-orphans"
    - ssh -t service@deputy.ocr.cr14.net "docker image prune -f"

    - echo "Deputy Package Server deployed, howdy!"
  only:
    - master
    - tags
